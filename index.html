<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- ä¼˜åŒ–viewportï¼šç¦æ­¢ç”¨æˆ·ç¼©æ”¾ï¼Œé€‚é…ç§»åŠ¨ç«¯è§†å£ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ç½‘ç»œè¡¨è¾¾æ¨¡æ‹Ÿä½“éªŒ-éšå½¢ç½‘æš´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            /* é˜´æ²‰èƒŒæ™¯ï¼šæ·±ç°åº•è‰² + æš—ç´«è‰²æ¸å˜ */
            background: #1a1a1f radial-gradient(circle at 50% 50%, rgba(30,30,40,0.9) 0%, #101015 100%);
            overflow: hidden;
            transition: background-color 0.5s ease, box-shadow 0.5s ease, filter 0.5s ease;
            position: relative;
            color: #ccc;
        }

        /* æ¸¸æˆå¤±è´¥åæ˜¾ç¤ºé¼ æ ‡çš„bodyæ ·å¼ */
        body.game-ended {
            cursor: default !important;
        }

        /* æ¸¸æˆè¿è¡Œä¸­éšè—é¼ æ ‡ï¼ˆä»…ç”µè„‘ç«¯ï¼‰ */
        body.game-running {
            cursor: none !important;
        }

        /* åŠ¨æ€å…‰æ–‘èƒŒæ™¯ - æ›´æš—æ²‰çš„å™ªç‚¹æ•ˆæœ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.6' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: -1;
            animation: noiseMove 12s infinite linear;
            opacity: 0.8;
        }

        @keyframes noiseMove {
            0% { transform: translate(0, 0); }
            50% { transform: translate(-8px, -8px); }
            100% { transform: translate(0, 0); }
        }

        /* ç”Ÿå‘½å€¼è¿‡ä½å‘¼å¸æ•ˆæœ - æ›´é˜´æ²‰çš„é—ªçƒ */
        @keyframes dangerBreath {
            0% { filter: brightness(0.8) contrast(1.1); }
            50% { filter: brightness(0.6) contrast(1.2); }
            100% { filter: brightness(0.8) contrast(1.1); }
        }

        /* ç”Ÿå‘½å€¼å®¹å™¨ - å±…ä¸­ä¸Šæ–¹ï¼Œé˜´æ²‰é£æ ¼ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼šç™¾åˆ†æ¯”å®½åº¦+å“åº”å¼é«˜åº¦ï¼‰ */
        .health-container {
            position: fixed;
            top: 20px; /* ç§»åŠ¨ç«¯å‡å°‘é¡¶éƒ¨é—´è· */
            left: 50%;
            transform: translateX(-50%);
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 600px; /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé€‚é…å¹³æ¿/ç”µè„‘ */
            height: 35px; /* ç§»åŠ¨ç«¯ç•¥å¾®ç¼©å°é«˜åº¦ */
            background-color: rgba(30, 30, 40, 0.8);
            border: 3px solid #992222;
            border-radius: 20px;
            overflow: hidden;
            z-index: 100;
            box-shadow: 0 0 20px rgba(153, 34, 34, 0.4);
            backdrop-filter: blur(10px);
            transition: transform 0.1s ease;
        }

        /* ç”Ÿå‘½å€¼è¿›åº¦ - æš—çº¢è‰²è°ƒ */
        .health-bar {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, #992222, #661111);
            transition: width 0.3s ease, background 0.3s ease;
            position: relative;
        }

        .health-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to right,
                rgba(200,200,200,0.1) 0%,
                rgba(200,200,200,0.2) 50%,
                rgba(200,200,200,0.1) 100%
            );
            animation: shimmer 3s infinite linear;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* ç”Ÿå‘½å€¼æ–‡å­—æç¤º - æš—çº¢è‰²ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼šç¼©å°å­—ä½“+è°ƒæ•´é—´è·ï¼‰ */
        .health-text {
            position: fixed;
            top: 25px; /* å¯¹åº”ç”Ÿå‘½å€¼å®¹å™¨é—´è· */
            left: 50%;
            transform: translateX(-50%);
            color: #cc4444;
            font-size: 16px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            font-weight: bold;
            z-index: 101;
            text-shadow: 0 0 8px rgba(153, 34, 34, 0.8);
            transition: transform 0.1s ease;
        }

        /* æ¸¸æˆç”»å¸ƒ - æ·±è‰²èƒŒæ™¯ï¼ˆå¼ºåˆ¶å æ»¡å±å¹•ï¼Œç¦æ­¢ç§»åŠ¨ç«¯é»˜è®¤è§¦æ‘¸è¡Œä¸ºï¼‰ */
        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background-color: rgba(10, 10, 20, 0.3);
            transition: filter 0.2s ease, transform 0.1s ease;
            touch-action: none; /* ç¦æ­¢ç§»åŠ¨ç«¯è§¦æ‘¸é»˜è®¤è¡Œä¸ºï¼ˆç¼©æ”¾ã€æ»šåŠ¨ï¼‰ */
        }

        /* æ¸¸æˆå¤±è´¥å¼¹çª— - é˜´æ²‰é£æ ¼ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼šç™¾åˆ†æ¯”å®½åº¦+å“åº”å¼å†…è¾¹è·ï¼‰ */
        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(20, 20, 30, 0.98);
            color: #cc4444;
            padding: 30px 20px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 500px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            border-radius: 15px;
            text-align: center;
            z-index: 200;
            display: none;
            border: 2px solid #992222;
            box-shadow: 0 0 30px rgba(153, 34, 34, 0.6);
            animation: fadeIn 0.5s ease forwards;
        }

        /* æ¸¸æˆå¼€å§‹å¼¹çª— - é˜´æ²‰é£æ ¼ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼šç™¾åˆ†æ¯”å®½åº¦+å“åº”å¼å†…è¾¹è·ï¼‰ */
        .game-start {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(20, 20, 30, 0.98);
            color: #cc4444;
            padding: 30px 20px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 500px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            border-radius: 15px;
            text-align: center;
            z-index: 300; /* å±‚çº§é«˜äºå…¶ä»–å…ƒç´  */
            border: 2px solid #992222;
            box-shadow: 0 0 30px rgba(153, 34, 34, 0.6);
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .game-start h2 {
            color: #cc4444;
            margin-bottom: 10px;
            font-size: 28px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            text-shadow: 0 0 10px rgba(204, 68, 68, 0.6);
        }

        .game-start .sub-title {
            color: #aa3333;
            font-size: 20px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            margin-bottom: 20px;
            font-weight: bold;
        }

        .game-over h2, .game-start h3 {
            color: #cc4444;
            margin-bottom: 20px;
            font-size: 28px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            text-shadow: 0 0 10px rgba(204, 68, 68, 0.6);
        }

        .game-over p, .game-start p {
            font-size: 16px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            margin-bottom: 25px;
            line-height: 1.8;
            color: #bbb;
        }

        .game-over button, .game-start button {
            padding: 10px 30px; /* ç§»åŠ¨ç«¯ç¼©å°æŒ‰é’®å†…è¾¹è· */
            font-size: 18px; /* ç§»åŠ¨ç«¯ç¼©å°æŒ‰é’®å­—ä½“ */
            background: linear-gradient(90deg, #992222, #661111);
            color: #eee;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(153, 34, 34, 0.5);
            touch-action: manipulation; /* æŒ‰é’®è§¦æ‘¸ä¼˜åŒ–ï¼Œé˜²æ­¢åŒå‡»ç¼©æ”¾ */
        }

        .game-over button:hover, .game-start button:hover {
            background: linear-gradient(90deg, #881111, #550000);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(153, 34, 34, 0.7);
        }

        .game-over button:focus, .game-start button:focus {
            outline: 3px solid #992222;
            outline-offset: 2px;
        }

        /* æ¸¸æˆè¯´æ˜ - é˜´æ²‰é£æ ¼ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼šç™¾åˆ†æ¯”å®½åº¦+ç¼©å°å­—ä½“ï¼‰ */
        .instructions {
            position: fixed;
            bottom: 120px; /* å¯¹åº”è¯„è®ºå¡ç‰‡é—´è· */
            left: 50%;
            transform: translateX(-50%);
            color: #cc4444;
            font-size: 12px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            text-align: center;
            z-index: 100;
            background-color: rgba(30, 30, 40, 0.8);
            padding: 8px 15px; /* ç§»åŠ¨ç«¯ç¼©å°å†…è¾¹è· */
            border-radius: 20px;
            backdrop-filter: blur(5px);
            transition: transform 0.1s ease;
            text-shadow: 0 0 3px #330000;
            border: 1px solid #551111;
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 500px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
        }

        /* è¯„è®ºå¡ç‰‡æ ·å¼ - é˜´æ²‰é£æ ¼ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼šç™¾åˆ†æ¯”å®½åº¦+è‡ªåŠ¨é«˜åº¦ï¼‰ */
        .comment-card {
            position: fixed;
            bottom: 15px; /* ç§»åŠ¨ç«¯å‡å°‘åº•éƒ¨é—´è· */
            left: 50%;
            transform: translateX(-50%);
            width: 90%; /* ç§»åŠ¨ç«¯ç™¾åˆ†æ¯”å®½åº¦ */
            max-width: 550px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
            height: auto; /* ç§»åŠ¨ç«¯è‡ªåŠ¨é«˜åº¦ï¼Œé€‚é…å†…å®¹ */
            min-height: 90px; /* é™åˆ¶æœ€å°é«˜åº¦ */
            background-color: rgba(30, 30, 40, 0.95);
            border-radius: 15px;
            padding: 15px; /* ç§»åŠ¨ç«¯å‡å°‘å†…è¾¹è· */
            display: flex;
            align-items: center;
            gap: 15px; /* ç§»åŠ¨ç«¯å‡å°‘é—´è· */
            box-shadow: 0 0 20px rgba(153, 34, 34, 0.3);
            z-index: 100;
            border: 2px solid #551111;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        /* è¯„è®ºå¤´åƒ - é˜´æ²‰é£æ ¼ï¼ˆç§»åŠ¨ç«¯ç¼©å°å°ºå¯¸ï¼‰ */
        .comment-avatar {
            width: 60px; /* ç§»åŠ¨ç«¯ç¼©å°å¤´åƒ */
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            color: #eee;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(153, 34, 34, 0.4);
            transition: all 0.3s ease;
            flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«å‹ç¼© */
        }

        /* å¤´åƒè„‰å†²åŠ¨ç”» - æ›´ç¼“æ…¢çš„è„‰å†² */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        /* è¯„è®ºå†…å®¹åŒºåŸŸ - é˜´æ²‰æ–‡å­—é¢œè‰²ï¼ˆç§»åŠ¨ç«¯ç¼©å°å­—ä½“ï¼‰ */
        .comment-content {
            flex: 1;
            color: #bbb;
        }

        .comment-author {
            font-size: 16px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            font-weight: bold;
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .comment-text {
            font-size: 15px; /* ç§»åŠ¨ç«¯ç¼©å°å­—ä½“ */
            line-height: 1.5;
            color: #aaa;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            word-wrap: break-word; /* ç§»åŠ¨ç«¯è‡ªåŠ¨æ¢è¡Œï¼Œé˜²æ­¢æ–‡å­—æº¢å‡º */
        }

        /* é—ªçƒæ•ˆæœç±» - æ›´é˜´æ²‰çš„é—ªçƒ */
        .flash-effect {
            filter: brightness(0.9) contrast(1.3) sepia(0.2);
        }

        /* ç²’å­æ•ˆæœæ ·å¼ - æš—æ²‰çš„ç²’å­ */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFade 1s ease forwards;
            opacity: 0.7;
        }

        @keyframes particleFade {
            0% { opacity: 0.9; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        /* ç§»åŠ¨ç«¯æ§åˆ¶å°çƒï¼ˆé˜´æ²‰é£æ ¼ï¼Œé»˜è®¤éšè—ï¼Œæ¸¸æˆè¿è¡Œæ—¶æ˜¾ç¤ºï¼‰ */
        .control-ball {
            position: fixed;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #992222, #661111);
            box-shadow: 0 0 15px rgba(204, 68, 68, 0.8);
            pointer-events: none; /* ä¸é˜»æŒ¡è§¦æ‘¸äº‹ä»¶ */
            z-index: 90; /* ä½äºå…¶ä»–UIï¼Œé«˜äºç”»å¸ƒ */
            display: none; /* åˆå§‹éšè— */
            touch-action: none;
        }
    </style>
</head>
<body>
    <!-- æ¸¸æˆå¼€å§‹å¼¹çª— -->
    <div class="game-start" id="gameStart">
        <h2>å¼‚åŒ–æ¢—è¡¨è¾¾</h2>
        <div class="sub-title">æ‰¹åˆ¤å¯¹è±¡ï¼šâ€œäººâ€</div>
        <p>
            ç›®æ ‡ï¼š<br>
            èº²é¿çº¢è‰²è¨€å¼¹<br>
            ç§»åŠ¨ç«¯ï¼šç‚¹å‡»é¡µé¢ä»»æ„å¤„ï¼Œæ§åˆ¶å°çƒç§»åŠ¨
        </p>
        <button onclick="startGame()">å¼€å§‹æ¨¡æ‹Ÿ</button>
    </div>

    <!-- ç”Ÿå‘½å€¼åŒºåŸŸ -->
    <div class="health-container" id="healthContainer">
        <div class="health-bar" id="healthBar"></div>
    </div>
    <div class="health-text" id="healthText">ç”Ÿå‘½å€¼: 100</div>

    <!-- æ¸¸æˆç”»å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

    <!-- ç§»åŠ¨ç«¯æ§åˆ¶å°çƒï¼ˆé˜´æ²‰é£æ ¼ï¼‰ -->
    <div class="control-ball" id="controlBall"></div>

    <!-- æ¸¸æˆå¤±è´¥å¼¹çª— - ä¿®æ”¹æŒ‰é’®æ–‡å­—å’Œç‚¹å‡»äº‹ä»¶ -->
    <div class="game-over" id="gameOver">
        <h2>æ¨¡æ‹Ÿç»“æŸ</h2>
        <p>æ— è®ºå—å®³è€…å¦‚ä½•èº²é¿ï¼Œ<br>å¼‚åŒ–çš„è¡¨è¾¾ä»ä¼šé“ºå¤©ç›–åœ°åœ°å‘å—å®³è€…åˆºå»â€¦â€¦</p>
        <button onclick="goToSystemInterface()">è¿”å›ç³»ç»Ÿ</button>
    </div>

    <!-- æ¸¸æˆè¯´æ˜ -->
    <div class="instructions" id="instructions">
       ç°è‰²=è·¯äºº(æ— æ•ˆæœ) | çº¢è‰²=å¼‚åŒ–æ¢—è¡¨è¾¾(å‡ç”Ÿå‘½å€¼) | ç»¿è‰²=æš–å¿ƒè¨€è®º(åŠ ç”Ÿå‘½å€¼)
    </div>

    <!-- è¯„è®ºå¡ç‰‡ -->
    <div class="comment-card" id="commentCard">
        <div class="comment-avatar" id="commentAvatar">ğŸ˜</div>
        <div class="comment-content">
            <div class="comment-author" id="commentAuthor">è·¯äºº</div>
            <div class="comment-text" id="commentText">ç­‰å¾…äº’åŠ¨...</div>
        </div>
    </div>

    <script>
        // ========== éŸ³é¢‘èµ„æºåˆå§‹åŒ– ==========
        const audio = {
            hitRed: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3'),
            hitGreen: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-positive-interface-beep-221.mp3'),
            hitGray: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3'),
            gameOver: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-failure-arcade-alert-notification-240.mp3'),
            bgm: new Audio('https://assets.mixkit.co/music/preview/mixkit-suspenseful-piano-sting-139.mp3')
        };

        // å…¨å±€æ‰“å­—æœºå®šæ—¶å™¨ï¼Œç”¨äºä¸­æ–­é‡å¤è¯„è®º
        let typingTimer = null;

        // åˆå§‹åŒ–éŸ³é¢‘è®¾ç½®
        function initAudio() {
            audio.bgm.loop = true;
            audio.bgm.volume = 0.2; // é™ä½èƒŒæ™¯éŸ³ä¹éŸ³é‡ï¼Œæ›´é˜´æ²‰
            audio.hitRed.volume = 0.5;
            audio.hitGreen.volume = 0.3;
            audio.hitGray.volume = 0.2;
            audio.gameOver.volume = 0.6;

            // é¡µé¢äº¤äº’åæ’­æ”¾èƒŒæ™¯éŸ³ä¹ï¼ˆå…¼å®¹æµè§ˆå™¨ç­–ç•¥ï¼‰
            document.addEventListener('click', () => {
                audio.bgm.play().catch(e => console.log('éŸ³é¢‘è‡ªåŠ¨æ’­æ”¾å—é™ï¼Œç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®å³å¯æ’­æ”¾'));
            }, { once: true });
        }

        // ========== DOMå…ƒç´ è·å– ==========
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const healthBar = document.getElementById('healthBar');
        const healthText = document.getElementById('healthText');
        const gameOverModal = document.getElementById('gameOver');
        const gameStartModal = document.getElementById('gameStart');
        const commentAvatar = document.getElementById('commentAvatar');
        const commentAuthor = document.getElementById('commentAuthor');
        const commentText = document.getElementById('commentText');
        const healthContainer = document.getElementById('healthContainer');
        const instructions = document.getElementById('instructions');
        const commentCard = document.getElementById('commentCard');
        const body = document.body;
        const controlBall = document.getElementById('controlBall'); // ç§»åŠ¨ç«¯æ§åˆ¶å°çƒ

        // ========== æ¸¸æˆå‚æ•° ==========
        let canvasWidth = window.innerWidth;
        let canvasHeight = window.innerHeight;
        let health = 100; // ç”Ÿå‘½å€¼ï¼Œåˆå§‹100ï¼Œä¸‹é™0
        let mouseX = canvasWidth / 2;
        let mouseY = canvasHeight / 2;
        let bullets = [];
        let gameTime = 0;
        let gameRunning = false; // åˆå§‹ä¸ºfalseï¼Œç‚¹å‡»å¼€å§‹åè®¾ä¸ºtrue
        let isHealth20Triggered = false; // ç”Ÿå‘½å€¼ä½äº20è§¦å‘å±é™©è§†è§‰æ•ˆæœ
        let shakeInterval = null;
        let flashInterval = null;
        let lastFrameTime = 0; // å¸§ç‡æ§åˆ¶
        let is18SecondsTriggered = false; // æ ‡è®°18ç§’å·¨é‡çº¢å¼¹æ˜¯å¦å·²è§¦å‘
        let isTouchDevice = /Mobile|Android|iOS|iPad|iPhone|iPod|Windows Phone|BlackBerry/.test(navigator.userAgent); // åˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        let isTouching = false; // æ˜¯å¦æ­£åœ¨è§¦æ‘¸å±å¹•ï¼ˆç§»åŠ¨ç«¯ä¸“ç”¨ï¼‰

        // ========== åˆ†é˜¶æ®µè¯„è®ºåº“ ==========
        const commentLibrary = {
            // é˜¶æ®µ1ï¼šå‰10ç§’
            stage1: {
                gray: ["è·¯è¿‡", "åœ¨åµä»€ä¹ˆå‘¢", "æ¥å‡‘çƒ­é—¹äº†"],
                red: ["é€†å¤©ï¼åŸæ¥æ˜¯éœ‡æ’¼é¦–å‘ï¼", "å‚è€ƒæ–‡çŒ®ï¼š[1]ä½æƒ…å•†çš„äººè¯´è¯æœ‰ä»€ä¹ˆç‰¹ç‚¹", "æœ‰æ²¡æœ‰å‚è€ƒæ–‡çŒ®å•Šï¼Ÿ"],
                green: ["åˆ«ç°å¿ƒï¼", "æˆ‘ç†è§£ä½ ", "åˆ«å¬åˆ«äººçè¯´"]
            },
            // é˜¶æ®µ2ï¼š10-30ç§’
            stage2: {
                gray: ["è·¯è¿‡~", "åœ¨åµä»€ä¹ˆå‘¢", "æ¥å‡‘çƒ­é—¹äº†"],
                red: ["é€†å¤©ï¼åŸæ¥æ˜¯éœ‡æ’¼é¦–å‘ï¼", "å‚è€ƒæ–‡çŒ®ï¼š[1]ä½æƒ…å•†çš„äººè¯´è¯æœ‰ä»€ä¹ˆç‰¹ç‚¹", "æœ‰æ²¡æœ‰å‚è€ƒæ–‡çŒ®å•Šï¼Ÿ"],
                green: ["åˆ«ç°å¿ƒï¼", "åˆ«å¬åˆ«äººçè¯´",  "æˆ‘ç†è§£ä½ "]
            },
            // é˜¶æ®µ3ï¼š30ç§’å
            stage3: {
                gray: ["è·¯è¿‡", "åœ¨åµä»€ä¹ˆå‘¢", "æ¥å‡‘çƒ­é—¹äº†"],
                red: ["æ˜¯ä¸æ˜¯æ™ºå•†æœ‰é—®é¢˜ï¼Ÿ", "éœ‡æ’¼é¦–å‘ï¼", "å‚è€ƒæ–‡çŒ®ï¼š[1]ä½æƒ…å•†çš„äººè¯´è¯æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿ"],
                green: ["åˆ«å¬åˆ«äººçè¯´", "åˆ«ç°å¿ƒï¼", "æˆ‘ç†è§£ä½ "]
            }
        };

        // ========== å·¥å…·å‡½æ•° ==========
        // è°ƒæ•´ç”»å¸ƒå¤§å°ï¼ˆç§»åŠ¨ç«¯é€‚é…ï¼šè§¦æ‘¸ç»“æŸåé‡ç½®å…‰æ ‡ä½ç½®ï¼‰
        function resizeCanvas() {
            canvasWidth = window.innerWidth;
            canvasHeight = window.innerHeight;
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // è‹¥æœªè§¦æ‘¸ï¼Œä¿æŒå…‰æ ‡åœ¨å±å¹•ä¸­å¤®ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
            if (!gameRunning || (isTouchDevice && !isTouching)) {
                mouseX = canvasWidth / 2;
                mouseY = canvasHeight / 2;
                updateControlBallPosition();
            }
        }

        // æ›´æ–°ç§»åŠ¨ç«¯æ§åˆ¶å°çƒä½ç½®ï¼ˆä¸“å±ç§»åŠ¨ç«¯ï¼‰
        function updateControlBallPosition() {
            if (!isTouchDevice) return;
            controlBall.style.left = `${mouseX - controlBall.offsetWidth / 2}px`;
            controlBall.style.top = `${mouseY - controlBall.offsetHeight / 2}px`;
        }

        // è·å–åˆ†é˜¶æ®µéšæœºè¯„è®º
        function getRandomComment(type) {
            let stage;
            if (gameTime < 600) stage = 'stage1';
            else if (gameTime < 1800) stage = 'stage2';
            else stage = 'stage3';

            const comments = commentLibrary[stage][type] || commentLibrary.stage1[type];
            return comments[Math.floor(Math.random() * comments.length)];
        }

        // åˆ›å»ºç¢°æ’ç²’å­æ•ˆæœ - æ›´æš—æ²‰çš„ç²’å­é¢œè‰²
        function createParticles(x, y, type) {
            const particleCount = 15;
            const colors = {
                gray: '#555555',    // æ·±ç°è‰²
                red: '#882222',     // æš—çº¢è‰²
                green: '#557722'    // æš—ç»¿è‰²
            };

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.width = `${5 + Math.random() * 10}px`;
                particle.style.height = particle.style.width;
                particle.style.backgroundColor = colors[type];
                particle.style.opacity = '0.7';

                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 5;
                const dx = Math.cos(angle) * speed;
                const dy = Math.sin(angle) * speed;

                let startTime = Date.now();
                function updateParticle() {
                    const elapsed = Date.now() - startTime;
                    if (elapsed > 1000) {
                        particle.remove();
                        return;
                    }

                    particle.style.left = `${x + dx * elapsed / 20}px`;
                    particle.style.top = `${y + dy * elapsed / 20}px`;
                    requestAnimationFrame(updateParticle);
                }

                document.body.appendChild(particle);
                requestAnimationFrame(updateParticle);
            }
        }

        // æ›´æ–°èƒŒæ™¯é¢œè‰²å’Œå±é™©è§†è§‰æ•ˆæœ - æ›´é˜´æ²‰çš„è‰²è°ƒå˜åŒ–
        function updateBackgroundColor() {
            // ç”Ÿå‘½å€¼100 â†’ æ·±ç°è‰²ï¼›ç”Ÿå‘½å€¼0 â†’ æš—çº¢è‰²
            const red = Math.floor(30 + (100 - health) / 100 * 40);
            const green = Math.floor(30 - (100 - health) / 100 * 20);
            const blue = Math.floor(40 - (100 - health) / 100 * 30);
            body.style.backgroundColor = `#${red.toString(16).padStart(2, '0')}${green.toString(16).padStart(2, '0')}${blue.toString(16).padStart(2, '0')}`;

            // ç”Ÿå‘½å€¼è¶Šä½ï¼Œçº¢è‰²å…‰æ™•è¶Šé‡ï¼Œå±é™©æ„Ÿè¶Šå¼º
            const opacity = (100 - health) / 100;
            body.style.boxShadow = `inset 0 0 200px rgba(153, 34, 34, ${opacity * 0.8})`;

            // ç”Ÿå‘½å€¼ä½äº20æ—¶æ·»åŠ å±é™©å‘¼å¸æ•ˆæœ
            body.style.animation = health < 20 ? 'dangerBreath 1.5s infinite ease-in-out' : '';
        }

        // ç”»é¢å±é™©æŠ–åŠ¨æ•ˆæœ
        function dangerShakeScreen() {
            const shakeAmount = 8;
            const elements = [canvas, healthContainer, healthText, instructions, commentCard];

            elements.forEach(el => {
                const x = (Math.random() - 0.5) * shakeAmount;
                const y = (Math.random() - 0.5) * shakeAmount;

                if (el === canvas) {
                    el.style.transform = `translate(${x}px, ${y}px)`;
                } else if (el === healthContainer || el === commentCard) {
                    el.style.transform = `translate(${x}px, ${y}px) translateX(-50%)`;
                } else if (el === healthText || el === instructions) {
                    el.style.transform = `translate(${x}px, ${y}px) translateX(-50%)`;
                }
            });

            setTimeout(() => {
                canvas.style.transform = 'translate(0, 0)';
                healthContainer.style.transform = 'translateX(-50%)';
                healthText.style.transform = 'translateX(-50%)';
                instructions.style.transform = 'translateX(-50%)';
                commentCard.style.transform = 'translateX(-50%)';
            }, 100);
        }

        // ç”»é¢å±é™©é—ªçƒæ•ˆæœ
        function dangerFlashScreen() {
            canvas.classList.add('flash-effect');
            setTimeout(() => {
                canvas.classList.remove('flash-effect');
            }, 200);
        }

        // æ›´æ–°è¯„è®ºå¡ç‰‡ï¼ˆå¸¦æ‰“å­—æœºæ•ˆæœï¼‰- æ¥æ”¶ä¸“å±è¯„è®ºå‚æ•°
        function updateCommentCard(type, comment) {
            // æ¸…é™¤ä¸Šä¸€ä¸ªæ‰“å­—æœºå®šæ—¶å™¨ï¼Œé˜²æ­¢é‡å¤åˆ·å±
            if (typingTimer) clearInterval(typingTimer);

            // è®¾ç½®å¤´åƒæ ·å¼å’Œè¡¨æƒ… - é˜´æ²‰é£æ ¼é…è‰²
            switch(type) {
                case 'gray':
                    commentAvatar.style.backgroundColor = '#555555';
                    commentAvatar.style.boxShadow = '0 0 15px rgba(85, 85, 85, 0.6)';
                    commentAvatar.textContent = 'ğŸ˜';
                    commentAuthor.textContent = 'è·¯äºº';
                    commentAuthor.style.color = '#888888';
                    break;
                case 'red':
                    commentAvatar.style.backgroundColor = '#882222';
                    commentAvatar.style.boxShadow = '0 0 15px rgba(136, 34, 34, 0.8)';
                    commentAvatar.textContent = 'ğŸ˜ ';
                    commentAuthor.textContent = 'å¼‚åŒ–æ¢—è¡¨è¾¾';
                    commentAuthor.style.color = '#cc4444';
                    break;
                case 'green':
                    commentAvatar.style.backgroundColor = '#557722';
                    commentAvatar.style.boxShadow = '0 0 15px rgba(85, 119, 34, 0.8)';
                    commentAvatar.textContent = 'ğŸ˜Š';
                    commentAuthor.textContent = 'æš–å¿ƒè¨€è®º';
                    commentAuthor.style.color = '#88aa44';
                    break;
            }

            // æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºä¸“å±è¯„è®º
            commentText.textContent = '';
            let index = 0;
            typingTimer = setInterval(() => {
                if (index < comment.length) {
                    commentText.textContent += comment.charAt(index);
                    index++;
                } else {
                    clearInterval(typingTimer);
                    typingTimer = null;
                }
            }, 50);

            // å¤´åƒè„‰å†²åŠ¨ç”»
            commentAvatar.style.animation = 'pulse 0.8s ease'; // æ›´æ…¢çš„è„‰å†²
            setTimeout(() => {
                commentAvatar.style.animation = '';
            }, 800);

            // å¡ç‰‡ç¼©æ”¾åé¦ˆ
            commentCard.style.transform = 'translateX(-50%) scale(1.05)';
            setTimeout(() => {
                commentCard.style.transform = 'translateX(-50%) scale(1)';
            }, 200);

            // åˆ›å»ºç²’å­æ•ˆæœ
            createParticles(mouseX, mouseY, type);
        }

        // æ‰¹é‡ç”Ÿæˆçº¢è‰²è¨€å¼¹ï¼ˆ18ç§’è§¦å‘ï¼‰
        function spawnMassiveRedBullets() {
            // ä¸€æ¬¡æ€§ç”Ÿæˆ50ä¸ªçº¢è‰²è¨€å¼¹ï¼ˆå·¨é‡æŠ•æ”¾ï¼‰
            const massiveCount = 50;
            for (let i = 0; i < massiveCount; i++) {
                // åˆ†æ•£ç”Ÿæˆä½ç½®ï¼Œè®©è¨€å¼¹ä»å±å¹•å„ä¸ªæ–¹å‘è¢­æ¥
                const randomSide = Math.floor(Math.random() * 4);
                let x, y;

                switch(randomSide) {
                    case 0: // é¡¶éƒ¨
                        x = Math.random() * canvasWidth;
                        y = -50 - (Math.random() * 100);
                        break;
                    case 1: // å³ä¾§
                        x = canvasWidth + 50 + (Math.random() * 100);
                        y = Math.random() * canvasHeight;
                        break;
                    case 2: // åº•éƒ¨
                        x = Math.random() * canvasWidth;
                        y = canvasHeight + 50 + (Math.random() * 100);
                        break;
                    case 3: // å·¦ä¾§
                        x = -50 - (Math.random() * 100);
                        y = Math.random() * canvasHeight;
                        break;
                }

                const bullet = new Bullet('red');
                bullet.x = x;
                bullet.y = y;
                bullet.speed = bullet.speed * 1.2; // 18ç§’åçº¢å¼¹é€Ÿåº¦æå‡20%
                bullets.push(bullet);
            }

            // å¼ºåŒ–è§†è§‰æ•ˆæœï¼šå¢åŠ å±é™©æŠ–åŠ¨é¢‘ç‡å’Œå¼ºåº¦
            if (shakeInterval) clearInterval(shakeInterval);
            shakeInterval = setInterval(() => {
                dangerShakeScreen();
                // é¢å¤–çš„å±é™©æŠ–åŠ¨
                setTimeout(dangerShakeScreen, 50);
            }, 80);

            // å¼ºåŒ–é—ªçƒæ•ˆæœ
            if (flashInterval) clearInterval(flashInterval);
            flashInterval = setInterval(dangerFlashScreen, 150);

            // èƒŒæ™¯å˜æš—çº¢è‰²ï¼Œå¼ºåŒ–å±é™©æ„Ÿ
            body.style.backgroundColor = '#441515';
            body.style.boxShadow = 'inset 0 0 200px rgba(136, 34, 34, 0.9)';
        }

        // ========== ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶å¤„ç† ==========
        // è§¦æ‘¸å¼€å§‹äº‹ä»¶
        function handleTouchStart(e) {
            if (!gameRunning) return;
            isTouching = true;
            // è·å–ç¬¬ä¸€ä¸ªè§¦æ‘¸ç‚¹çš„åæ ‡
            const touch = e.touches[0];
            mouseX = touch.clientX;
            mouseY = touch.clientY;
            updateControlBallPosition();
        }

        // è§¦æ‘¸ç§»åŠ¨äº‹ä»¶
        function handleTouchMove(e) {
            if (!gameRunning || !isTouching) return;
            e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨ç­‰é»˜è®¤è¡Œä¸º
            const touch = e.touches[0];
            mouseX = touch.clientX;
            mouseY = touch.clientY;
            updateControlBallPosition();
        }

        // è§¦æ‘¸ç»“æŸäº‹ä»¶
        function handleTouchEnd() {
            isTouching = false;
            // ç§»åŠ¨ç«¯è§¦æ‘¸ç»“æŸåï¼Œå°çƒä»ä¿ç•™åœ¨æœ€åä½ç½®
            updateControlBallPosition();
        }

        // ========== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==========
        // å¼€å§‹æ¸¸æˆï¼ˆç‚¹å‡»å¼¹çª—æŒ‰é’®åæ‰§è¡Œï¼‰
        function startGame() {
            // éšè—å¼€å§‹å¼¹çª—
            gameStartModal.style.display = 'none';
            // åˆå§‹åŒ–æ¸¸æˆ
            initGame();
        }

        // ä¿®æ”¹2ï¼šåˆ é™¤restartGameå‡½æ•°ï¼Œæ–°å¢goToSystemInterfaceå‡½æ•°
        // è¿”å›ç³»ç»Ÿç•Œé¢ï¼ˆè·³è½¬åˆ°æŒ‡å®šURLï¼‰
        function goToSystemInterface() {
            // åœæ­¢èƒŒæ™¯éŸ³ä¹
            audio.bgm.pause();
            // éšè—å¤±è´¥å¼¹çª—
            gameOverModal.style.display = 'none';

            // æ ¸å¿ƒä¿®æ”¹ï¼šè·³è½¬åˆ°æŒ‡å®šçš„URL
            window.location.href = "https://999isbest.github.io/back2/";
        }

        // åˆå§‹åŒ–æ¸¸æˆï¼ˆæ•´åˆç§»åŠ¨ç«¯é€‚é…é€»è¾‘ï¼‰
        function initGame() {
            initAudio(); // åˆå§‹åŒ–éŸ³é¢‘
            resizeCanvas();
            health = 100; // åˆå§‹ç”Ÿå‘½å€¼ä¸º100
            bullets = [];
            gameTime = 0;
            gameRunning = true; // æ ‡è®°æ¸¸æˆå¼€å§‹è¿è¡Œ
            isHealth20Triggered = false;
            is18SecondsTriggered = false; // é‡ç½®18ç§’è§¦å‘æ ‡è®°
            lastFrameTime = 0;
            isTouching = false;

            // åŒºåˆ†è®¾å¤‡ï¼šç”µè„‘ç«¯éšè—é¼ æ ‡ï¼Œç§»åŠ¨ç«¯æ˜¾ç¤ºæ§åˆ¶å°çƒ
            if (isTouchDevice) {
                body.classList.remove('game-running'); // ç§»åŠ¨ç«¯æ— éœ€éšè—é¼ æ ‡
                controlBall.style.display = 'block'; // æ˜¾ç¤ºç§»åŠ¨ç«¯æ§åˆ¶å°çƒ
                updateControlBallPosition();
            } else {
                body.classList.add('game-running'); // ç”µè„‘ç«¯éšè—é¼ æ ‡
            }
            body.classList.remove('game-ended');

            // æ¸…é™¤å®šæ—¶å™¨
            if (shakeInterval) clearInterval(shakeInterval);
            if (flashInterval) clearInterval(flashInterval);

            // é‡ç½®æ ·å¼
            updateHealth();
            updateBackgroundColor();
            canvas.classList.remove('flash-effect');
            canvas.style.transform = 'translate(0, 0)';
            healthContainer.style.transform = 'translateX(-50%)';
            healthText.style.transform = 'translateX(-50%)';
            instructions.style.transform = 'translateX(-50%)';
            commentCard.style.transform = 'translateX(-50%)';

            gameOverModal.style.display = 'none';
            // åˆå§‹åŒ–é»˜è®¤è¯„è®º
            updateCommentCard('gray', 'ç­‰å¾…äº’åŠ¨...');

            // ç»‘å®šäº‹ä»¶ï¼šåŒºåˆ†è®¾å¤‡ç»‘å®šä¸åŒäº¤äº’äº‹ä»¶
            window.addEventListener('resize', resizeCanvas);
            if (!isTouchDevice) {
                // ç”µè„‘ç«¯ï¼šé¼ æ ‡ç§»åŠ¨äº‹ä»¶
                canvas.addEventListener('mousemove', (e) => {
                    if (!gameRunning) return;
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
            } else {
                // ç§»åŠ¨ç«¯ï¼šè§¦æ‘¸äº‹ä»¶ç»‘å®š
                canvas.addEventListener('touchstart', handleTouchStart);
                canvas.addEventListener('touchmove', handleTouchMove);
                canvas.addEventListener('touchend', handleTouchEnd);
            }

            animate();
        }

        // æ›´æ–°ç”Ÿå‘½å€¼æ˜¾ç¤º
        function updateHealth() {
            healthBar.style.width = `${health}%`;
            healthText.textContent = `ç”Ÿå‘½å€¼: ${health}`;

            // ç”Ÿå‘½å€¼é¢œè‰²æ¸å˜ - æ›´æš—æ²‰çš„çº¢è‰²ç³»
            if (health > 60) {
                healthBar.style.background = 'linear-gradient(90deg, #994444, #882222)';
            } else if (health > 30) {
                healthBar.style.background = 'linear-gradient(90deg, #882222, #771111)';
            } else {
                healthBar.style.background = 'linear-gradient(90deg, #771111, #550000)';
            }

            updateBackgroundColor();

            // ç”Ÿå‘½å€¼ä½äº30æ—¶å¯åŠ¨å±é™©æŠ–åŠ¨å’Œé—ªçƒ
            if (health < 30 && gameRunning) {
                if (!shakeInterval) {
                    shakeInterval = setInterval(dangerShakeScreen, 150);
                }
                if (!flashInterval) {
                    flashInterval = setInterval(dangerFlashScreen, 300);
                }
            } else if (health >= 30 && !is18SecondsTriggered) {
                if (shakeInterval) {
                    clearInterval(shakeInterval);
                    shakeInterval = null;
                }
                if (flashInterval) {
                    clearInterval(flashInterval);
                    flashInterval = null;
                }
            }

            // æ¸¸æˆå¤±è´¥é€»è¾‘ï¼ˆç”Ÿå‘½å€¼ä¸º0ï¼‰
            if (health <= 0 && gameRunning) {
                gameRunning = false;
                // æ¸¸æˆå¤±è´¥åï¼šç§»åŠ¨ç«¯éšè—æ§åˆ¶å°çƒï¼Œç”µè„‘ç«¯æ˜¾ç¤ºé¼ æ ‡
                if (isTouchDevice) {
                    controlBall.style.display = 'none';
                } else {
                    body.classList.remove('game-running');
                }
                body.classList.add('game-ended');
                audio.gameOver.play(); // æ’­æ”¾æ¸¸æˆå¤±è´¥éŸ³æ•ˆ
                gameOverModal.style.display = 'block';
                if (shakeInterval) clearInterval(shakeInterval);
                if (flashInterval) clearInterval(flashInterval);
            }
        }

        // è¨€å¼¹ç±»ï¼ˆå·®å¼‚åŒ–è¡Œä¸ºï¼‰- é˜´æ²‰é£æ ¼é…è‰²
        class Bullet {
            constructor(type) {
                // åˆå§‹ä½ç½®
                this.x = Math.random() * canvasWidth;
                this.y = Math.random() > 0.5 ? -50 : canvasHeight + 50;

                // åŸºç¡€å±æ€§
                this.type = type;
                this.size = type === 'gray' ? 15 : (type === 'red' ? 20 : 18);

                // æ¯ä¸ªè¨€å¼¹åˆ›å»ºæ—¶ç»‘å®šä¸“å±è¯„è®º
                this.comment = getRandomComment(type);

                // å·®å¼‚åŒ–é€Ÿåº¦å’Œè¡Œä¸º
                switch(type) {
                    case 'gray': // è·¯äººï¼šæœ€æ…¢ï¼Œéšæœºå¾˜å¾Š
                        this.speed = 2 + Math.random() * 3;
                        this.wander = true;
                        this.wanderAngle = Math.random() * Math.PI * 2;
                        this.wanderSpeed = 0.05;
                        break;
                    case 'red': // è´Ÿé¢è¨€è®ºï¼šä¸­é€Ÿï¼Œç›´å¥”ç›®æ ‡ï¼ˆæ›´å…·æ”»å‡»æ€§ï¼‰
                        this.speed = 5 + Math.random() * 4;
                        this.wander = false;
                        break;
                    case 'green': // æš–å¿ƒè¯è¯­ï¼šä¸­ç­‰é€Ÿåº¦ï¼Œè½»å¾®å¾˜å¾Šï¼ˆæ›´å®¹æ˜“æ”¶é›†ï¼‰
                        this.speed = 3 + Math.random() * 3;
                        this.wander = true;
                        this.wanderAngle = Math.random() * Math.PI * 2;
                        this.wanderSpeed = 0.02;
                        break;
                }

                // æ¸å˜é¢œè‰² - é˜´æ²‰é£æ ¼
                this.gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.size
                );
                switch(type) {
                    case 'gray':
                        this.gradient.addColorStop(0, '#666666');
                        this.gradient.addColorStop(1, '#444444');
                        break;
                    case 'red':
                        this.gradient.addColorStop(0, '#994444');
                        this.gradient.addColorStop(1, '#772222');
                        break;
                    case 'green':
                        this.gradient.addColorStop(0, '#779944');
                        this.gradient.addColorStop(1, '#557722');
                        break;
                }
            }

            // æ›´æ–°è¨€å¼¹ä½ç½®ï¼ˆå¸¦å¾˜å¾Šæ•ˆæœï¼‰
            update() {
                let dx = mouseX - this.x;
                let dy = mouseY - this.y;

                // å¾˜å¾Šæ•ˆæœï¼ˆè·¯äºº/æš–å¿ƒè¯è¯­ï¼‰
                if (this.wander) {
                    this.wanderAngle += this.wanderSpeed;
                    dx += Math.cos(this.wanderAngle) * 15;
                    dy += Math.sin(this.wanderAngle) * 15;
                }

                const angle = Math.atan2(dy, dx);
                this.x += Math.cos(angle) * this.speed;
                this.y += Math.sin(angle) * this.speed;

                // æ›´æ–°æ¸å˜ä½ç½®
                this.gradient = ctx.createRadialGradient(
                    this.x, this.y, 0,
                    this.x, this.y, this.size
                );
                switch(this.type) {
                    case 'gray':
                        this.gradient.addColorStop(0, '#666666');
                        this.gradient.addColorStop(1, '#444444');
                        break;
                    case 'red':
                        this.gradient.addColorStop(0, '#994444');
                        this.gradient.addColorStop(1, '#772222');
                        break;
                    case 'green':
                        this.gradient.addColorStop(0, '#779944');
                        this.gradient.addColorStop(1, '#557722');
                        break;
                }

                // ç¢°æ’æ£€æµ‹
                const distance = Math.sqrt(
                    Math.pow(mouseX - this.x, 2) +
                    Math.pow(mouseY - this.y, 2)
                );

                if (distance < 25) {
                    this.handleCollision();
                    return true;
                }

                // è¶…å‡ºå±å¹•ç§»é™¤
                if (this.x < -50 || this.x > canvasWidth + 50 ||
                    this.y < -50 || this.y > canvasHeight + 50) {
                    return true;
                }

                return false;
            }

            // ç¢°æ’å¤„ç†ï¼ˆå¸¦éŸ³æ•ˆï¼‰
            handleCollision() {
                if (!gameRunning) return;

                // æ’­æ”¾å¯¹åº”éŸ³æ•ˆ
                switch(this.type) {
                    case 'red':
                        audio.hitRed.currentTime = 0;
                        audio.hitRed.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥'));
                        health = Math.max(0, health - 10); // è´Ÿé¢è¨€è®ºæ‰£é™¤10ç‚¹ç”Ÿå‘½å€¼
                        break;
                    case 'green':
                        audio.hitGreen.currentTime = 0;
                        audio.hitGreen.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥'));
                        health = Math.min(100, health + 15); // æš–å¿ƒè¯è¯­æ¢å¤15ç‚¹ç”Ÿå‘½å€¼
                        break;
                    case 'gray':
                        audio.hitGray.currentTime = 0;
                        audio.hitGray.play().catch(e => console.log('éŸ³æ•ˆæ’­æ”¾å¤±è´¥'));
                        break;
                }

                // ä¼ é€’å½“å‰è¨€å¼¹çš„ä¸“å±è¯„è®º
                updateCommentCard(this.type, this.comment);
                updateHealth();
            }

            // ç»˜åˆ¶è¨€å¼¹ - æ›´æš—æ²‰çš„é«˜å…‰å’Œå¤–å‘å…‰
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.gradient;
                ctx.fill();

                // é«˜å…‰æ•ˆæœ - æ›´æš—çš„é«˜å…‰
                ctx.beginPath();
                ctx.arc(this.x - this.size/3, this.y - this.size/3, this.size/4, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(200,200,200,0.4)';
                ctx.fill();

                // å¤–å‘å…‰æ•ˆæœ - æ›´æš—æ²‰çš„å‘å…‰
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size + 2, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(${this.type === 'red' ? 136 : this.type === 'green' ? 85 : 85},
                                    ${this.type === 'red' ? 34 : this.type === 'green' ? 119 : 85},
                                    ${this.type === 'red' ? 34 : this.type === 'green' ? 34 : 85}, 0.2)`;
                ctx.fill();
            }
        }

        // ç”Ÿæˆè¨€å¼¹ï¼ˆè°ƒæ•´æ¦‚ç‡ï¼Œçº¢è‰²è¨€å¼¹æ›´å¤šï¼‰
        function spawnBullets() {
            gameTime++;

            // 18ç§’ï¼ˆ1080å¸§ï¼‰è§¦å‘å·¨é‡çº¢è‰²è¨€å¼¹ï¼ˆä»…è§¦å‘ä¸€æ¬¡ï¼‰
            if (gameTime >= 1080 && !is18SecondsTriggered) {
                is18SecondsTriggered = true;
                spawnMassiveRedBullets();
            }

            // é™åˆ¶æœ€å¤§è¨€å¼¹æ•°é‡ï¼Œé˜²æ­¢å¡é¡¿
            if (bullets.length > 200) return;

            // åŸºç¡€ç”Ÿæˆè§„åˆ™ï¼ˆçº¢è‰²è¨€å¼¹æ¦‚ç‡æ›´é«˜ï¼‰
            let redChance = 0.55;    // çº¢è‰²ï¼š55%ï¼ˆä¸»è¦èº²é¿ç›®æ ‡ï¼‰
            let greenChance = 0.15;  // ç»¿è‰²ï¼š15%
            let grayChance = 0.3;    // ç°è‰²ï¼š30%
            let spawnRate = 5;

            // é˜¶æ®µéš¾åº¦è°ƒæ•´
            if (gameTime > 600) {
                redChance = 0.65;     // çº¢è‰²ï¼š65%
                greenChance = 0.15;   // ç»¿è‰²ï¼š15%
                grayChance = 0.2;     // ç°è‰²ï¼š20%
                spawnRate = 7;
            }

            if (gameTime > 1800) {
                redChance = 0.75;     // çº¢è‰²ï¼š75%
                greenChance = 0.1;    // ç»¿è‰²ï¼š10%
                grayChance = 0.15;    // ç°è‰²ï¼š15%
                spawnRate = 9;
            }

            // ç”Ÿå‘½å€¼ä½äº20æ—¶å¢åŠ ç»¿è‰²è¨€å¼¹æ¦‚ç‡ï¼ˆç»™ç©å®¶å–˜æ¯æœºä¼šï¼‰
            if (health < 20) {
                if (!isHealth20Triggered) {
                    isHealth20Triggered = true;
                }
                redChance = 0.5;      // çº¢è‰²ï¼š50%
                greenChance = 0.4;    // ç»¿è‰²ï¼š40%ï¼ˆæ›´å®¹æ˜“å›è¡€ï¼‰
                grayChance = 0.1;     // ç°è‰²ï¼š10%
                spawnRate = 11;
            }

            // 18ç§’åæŒç»­é«˜æ¦‚ç‡ç”Ÿæˆçº¢è‰²è¨€å¼¹
            if (is18SecondsTriggered) {
                redChance = 0.8;      // çº¢è‰²ï¼š80%
                greenChance = 0.15;   // ç»¿è‰²ï¼š15%
                grayChance = 0.05;    // ç°è‰²ï¼š5%
                spawnRate = 15;
            }

            // éšæœºç”Ÿæˆè¨€å¼¹
            if (Math.random() < spawnRate / 60) {
                let rand = Math.random();
                let type;

                if (rand < redChance) {
                    type = 'red';
                } else if (rand < redChance + greenChance) {
                    type = 'green';
                } else {
                    type = 'gray';
                }

                bullets.push(new Bullet(type));
            }
        }

        // æ¸¸æˆåŠ¨ç”»å¾ªç¯ï¼ˆå¸§ç‡æ§åˆ¶ï¼‰
        function animate(timestamp) {
            if (!gameRunning) return;

            // æ§åˆ¶å¸§ç‡ï¼ˆçº¦60fpsï¼‰
            const delta = timestamp - lastFrameTime;
            if (delta < 16) {
                requestAnimationFrame(animate);
                return;
            }
            lastFrameTime = timestamp;

            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvasWidth, canvasHeight);

            // ç”Ÿæˆæ–°è¨€å¼¹
            spawnBullets();

            // æ›´æ–°å’Œç»˜åˆ¶æ‰€æœ‰è¨€å¼¹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.draw();
                if (bullet.update()) {
                    bullets.splice(i, 1);
                }
            }

            // ç»˜åˆ¶è‡ªå®šä¹‰å…‰æ ‡ - ä»…ç”µè„‘ç«¯æ˜¾ç¤ºï¼Œç§»åŠ¨ç«¯ç”¨æ§åˆ¶å°çƒæ›¿ä»£
            if (!isTouchDevice) {
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 15, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(204, 68, 68, 0.8)';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(mouseX, mouseY, 18, 0, Math.PI * 2);
                ctx.strokeStyle = 'rgba(204, 68, 68, 0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            requestAnimationFrame(animate);
        }

        // é¡µé¢åŠ è½½å®Œæˆåä»…æ˜¾ç¤ºå¼€å§‹å¼¹çª—ï¼Œä¸è‡ªåŠ¨åˆå§‹åŒ–æ¸¸æˆ
        window.onload = function() {
            // ä»…åˆå§‹åŒ–ç”»å¸ƒå¤§å°ï¼Œä¸å¯åŠ¨æ¸¸æˆå¾ªç¯
            resizeCanvas();
            // ç»‘å®šé¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼ˆä»…ç”µè„‘ç«¯ï¼Œæ¸¸æˆæœªå¼€å§‹ä¹Ÿèƒ½æ•è·é¼ æ ‡ä½ç½®ï¼‰
            if (!isTouchDevice) {
                canvas.addEventListener('mousemove', (e) => {
                    mouseX = e.clientX;
                    mouseY = e.clientY;
                });
            }
        };
    </script>
</body>
</html>
